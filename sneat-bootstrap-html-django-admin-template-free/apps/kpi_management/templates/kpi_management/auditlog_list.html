{% extends layout_path %}
{% load static %}
{% load i18n %}

{% block title %}Audit Log{% endblock %}

{% block page_css %}
{% include 'kpi_management/_dark_mode_css.html' %}
{% endblock page_css %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}"/>
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Audit Log / Log Aktivitas</h5>
      </div>
      <div class="card-body">
        <!-- Search and Filter -->
        <form method="get" class="mb-4">
          <div class="row g-3">
            <div class="col-md-3">
              <input type="text" name="search" class="form-control" placeholder="Cari..." value="{{ request.GET.search }}">
            </div>
            <div class="col-md-3">
              <select name="user" class="form-select">
                <option value="">Semua User</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if request.GET.user == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <select name="action" class="form-select">
                <option value="">Semua Action</option>
                <option value="create" {% if request.GET.action == 'create' %}selected{% endif %}>Create</option>
                <option value="update" {% if request.GET.action == 'update' %}selected{% endif %}>Update</option>
                <option value="delete" {% if request.GET.action == 'delete' %}selected{% endif %}>Delete</option>
                <option value="login" {% if request.GET.action == 'login' %}selected{% endif %}>Login</option>
                <option value="approve" {% if request.GET.action == 'approve' %}selected{% endif %}>Approve</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
          </div>
        </form>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>User</th>
                <th>Action</th>
                <th>Target</th>
                <th>Description</th>
                <th>IP Address</th>
                <th>Waktu</th>
              </tr>
            </thead>
            <tbody>
              {% for log in page_obj %}
              <tr>
                <td>{{ log.user.username|default:"System" }}</td>
                <td>
                  <span class="badge bg-label-primary">{{ log.get_action_display }}</span>
                </td>
                <td>
                  {% if log.target_name %}
                    <strong>{{ log.target_type }}</strong>: {{ log.target_name }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ log.description|truncatewords:10|default:"-" }}</td>
                <td>{{ log.ip_address|default:"-" }}</td>
                <td>{{ log.created_at|date:"d M Y H:i" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center">Tidak ada data audit log</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}{% if request.GET.action %}&action={{ request.GET.action }}{% endif %}">Previous</a>
            </li>
            {% endif %}
            <li class="page-item active">
              <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}{% if request.GET.action %}&action={{ request.GET.action }}{% endif %}">Next</a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Analytics & Visualization Section -->
<div class="row g-4 mb-4">
  <!-- Activity Timeline Chart -->
  <div class="col-xl-8 col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Activity Timeline (7 Hari Terakhir)</h5>
      </div>
      <div class="card-body">
        <div id="activityTimelineChart" style="min-height: 300px;"></div>
      </div>
    </div>
  </div>

  <!-- Action Distribution Pie Chart -->
  <div class="col-xl-4 col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Action Distribution</h5>
      </div>
      <div class="card-body">
        <div id="actionDistributionChart" style="min-height: 300px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Top Users Activity -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Top 10 Users Activity</h5>
      </div>
      <div class="card-body">
        <div id="topUsersChart" style="min-height: 350px;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script>
  'use strict';

  // Wait for ApexCharts to be loaded
  function initAuditLogCharts() {
    if (typeof ApexCharts === 'undefined') {
      console.warn('ApexCharts not loaded yet, retrying...');
      setTimeout(initAuditLogCharts, 100);
      return;
    }

    // Parse data from context
    let activityTimelineData = { dates: [], create: [], update: [], delete: [], login: [] };
    let actionDistributionData = { labels: [], values: [] };
    let topUsersData = { labels: [], values: [] };

    try {
      {% if activity_timeline_data %}
      const activityTimelineDataStr = {{ activity_timeline_data|safe }};
      if (activityTimelineDataStr && typeof activityTimelineDataStr === 'string' && activityTimelineDataStr.trim() !== '' && activityTimelineDataStr !== '{}') {
        activityTimelineData = JSON.parse(activityTimelineDataStr);
      } else if (typeof activityTimelineDataStr === 'object' && activityTimelineDataStr !== null) {
        activityTimelineData = activityTimelineDataStr;
      }
      if (!activityTimelineData.dates) activityTimelineData.dates = [];
      if (!activityTimelineData.create) activityTimelineData.create = [];
      if (!activityTimelineData.update) activityTimelineData.update = [];
      if (!activityTimelineData.delete) activityTimelineData.delete = [];
      if (!activityTimelineData.login) activityTimelineData.login = [];
      {% endif %}
    } catch(e) {
      console.error('Error parsing activityTimelineData:', e);
      activityTimelineData = { dates: [], create: [], update: [], delete: [], login: [] };
    }

    try {
      {% if action_distribution_data %}
      const actionDistributionDataStr = {{ action_distribution_data|safe }};
      if (actionDistributionDataStr && typeof actionDistributionDataStr === 'string' && actionDistributionDataStr.trim() !== '' && actionDistributionDataStr !== '{}') {
        actionDistributionData = JSON.parse(actionDistributionDataStr);
      } else if (typeof actionDistributionDataStr === 'object' && actionDistributionDataStr !== null) {
        actionDistributionData = actionDistributionDataStr;
      }
      if (!actionDistributionData.labels) actionDistributionData.labels = [];
      if (!actionDistributionData.values) actionDistributionData.values = [];
      {% endif %}
    } catch(e) {
      console.error('Error parsing actionDistributionData:', e);
      actionDistributionData = { labels: [], values: [] };
    }

    try {
      {% if top_users_data %}
      const topUsersDataStr = {{ top_users_data|safe }};
      if (topUsersDataStr && typeof topUsersDataStr === 'string' && topUsersDataStr.trim() !== '' && topUsersDataStr !== '{}') {
        topUsersData = JSON.parse(topUsersDataStr);
      } else if (typeof topUsersDataStr === 'object' && topUsersDataStr !== null) {
        topUsersData = topUsersDataStr;
      }
      if (!topUsersData.labels) topUsersData.labels = [];
      if (!topUsersData.values) topUsersData.values = [];
      {% endif %}
    } catch(e) {
      console.error('Error parsing topUsersData:', e);
      topUsersData = { labels: [], values: [] };
    }

    // Activity Timeline Chart - Line Chart (konsisten dengan Story Trend Chart)
    const activityTimelineChartEl = document.querySelector('#activityTimelineChart');
    if (activityTimelineChartEl && typeof ApexCharts !== 'undefined') {
      // Ensure data exists
      if (!activityTimelineData.dates || activityTimelineData.dates.length === 0) {
        activityTimelineData = { dates: [], create: [], update: [], delete: [], login: [] };
      }

      const activityTimelineChartConfig = {
        chart: {
          height: 300,
          type: 'line',
          toolbar: { show: false }
        },
        series: [
          {
            name: 'Create',
            data: activityTimelineData.create || []
          },
          {
            name: 'Update',
            data: activityTimelineData.update || []
          },
          {
            name: 'Delete',
            data: activityTimelineData.delete || []
          },
          {
            name: 'Login',
            data: activityTimelineData.login || []
          }
        ],
        xaxis: {
          categories: activityTimelineData.dates || [],
          labels: {
            rotate: -45,
            rotateAlways: true
          }
        },
        colors: ['#696cff', '#71dd37', '#ff3e1d', '#ffab00'],
        stroke: {
          width: 2,
          curve: 'smooth'
        },
        markers: {
          size: 4
        },
        legend: {
          show: true,
          position: 'top'
        }
      };
      try {
        window.activityTimelineChart = new ApexCharts(activityTimelineChartEl, activityTimelineChartConfig);
        window.activityTimelineChart.render();
        console.log('✅ Activity Timeline Chart rendered successfully');
      } catch(e) {
        console.error('❌ Error rendering Activity Timeline Chart:', e);
      }
    } else {
      console.warn('⚠️  Activity Timeline Chart element not found');
    }

    // Action Distribution Chart - Donut Chart
    const actionDistributionChartEl = document.querySelector('#actionDistributionChart');
    if (actionDistributionChartEl && typeof ApexCharts !== 'undefined') {
      // Ensure data exists
      if (!actionDistributionData.labels || actionDistributionData.labels.length === 0) {
        actionDistributionData = { labels: ['Create', 'Update', 'Delete', 'Login', 'Other'], values: [0, 0, 0, 0, 0] };
      }

      const actionDistributionChartConfig = {
        chart: {
          height: 300,
          type: 'donut',
          toolbar: { show: false }
        },
        labels: actionDistributionData.labels || [],
        series: actionDistributionData.values || [],
        colors: ['#696cff', '#71dd37', '#ff3e1d', '#ffab00', '#03c3ec'],
        legend: {
          show: true,
          position: 'bottom'
        },
        dataLabels: {
          enabled: true,
          formatter: function(val) {
            return val.toFixed(1) + '%';
          }
        }
      };
      try {
        window.actionDistributionChart = new ApexCharts(actionDistributionChartEl, actionDistributionChartConfig);
        window.actionDistributionChart.render();
        console.log('✅ Action Distribution Chart rendered successfully');
      } catch(e) {
        console.error('❌ Error rendering Action Distribution Chart:', e);
      }
    } else {
      console.warn('⚠️  Action Distribution Chart element not found');
    }

    // Top Users Chart - Bar Chart (konsisten dengan grafik lainnya)
    const topUsersChartEl = document.querySelector('#topUsersChart');
    if (topUsersChartEl && typeof ApexCharts !== 'undefined') {
      // Ensure data exists
      if (!topUsersData.labels || topUsersData.labels.length === 0) {
        topUsersData = { labels: [], values: [] };
      }

      const topUsersChartConfig = {
        chart: {
          height: 350,
          type: 'bar',
          toolbar: { show: false }
        },
        series: [
          {
            name: 'Activity Count',
            data: topUsersData.values || []
          }
        ],
        xaxis: {
          categories: topUsersData.labels || []
        },
        colors: ['#696cff'],
        plotOptions: {
          bar: {
            horizontal: true,
            columnWidth: '60%',
            endingShape: 'rounded'
          }
        },
        dataLabels: {
          enabled: true
        },
        legend: {
          show: false
        }
      };
      try {
        window.topUsersChart = new ApexCharts(topUsersChartEl, topUsersChartConfig);
        window.topUsersChart.render();
        console.log('✅ Top Users Chart rendered successfully');
      } catch(e) {
        console.error('❌ Error rendering Top Users Chart:', e);
      }
    } else {
      console.warn('⚠️  Top Users Chart element not found');
    }
  }

  // Initialize charts when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAuditLogCharts);
  } else {
    initAuditLogCharts();
  }

  // Real-time update function
  function updateAuditLogCharts() {
    fetch('{% url "kpi_management:auditlog-charts-api" %}')
      .then(response => response.json())
      .then(data => {
        if (data.success && window.activityTimelineChart && window.actionDistributionChart && window.topUsersChart) {
          // Update Activity Timeline Chart
          window.activityTimelineChart.updateSeries([
            { name: 'Create', data: data.activity_timeline.create || [] },
            { name: 'Update', data: data.activity_timeline.update || [] },
            { name: 'Delete', data: data.activity_timeline.delete || [] },
            { name: 'Login', data: data.activity_timeline.login || [] }
          ]);
          window.activityTimelineChart.updateOptions({
            xaxis: { categories: data.activity_timeline.dates || [] }
          });

          // Update Action Distribution Chart
          window.actionDistributionChart.updateSeries(data.action_distribution.values || []);

          // Update Top Users Chart
          window.topUsersChart.updateOptions({
            xaxis: { categories: data.top_users.labels || [] }
          });
          window.topUsersChart.updateSeries([{
            name: 'Activity Count',
            data: data.top_users.values || []
          }]);
        }
      })
      .catch(error => {
        console.error('Error updating charts:', error);
      });
  }

  // Start real-time updates every 30 seconds after charts are rendered
  setTimeout(() => {
    if (window.activityTimelineChart && window.actionDistributionChart && window.topUsersChart) {
      setInterval(updateAuditLogCharts, 30000);
      console.log('✅ Real-time updates enabled for Audit Log charts');
    }
  }, 2000);
</script>
{% endblock page_js %}


